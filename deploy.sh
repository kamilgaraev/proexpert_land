#!/bin/bash

# Скрипт для автоматического деплоя ProExpert

# Проверка на наличие правильной директории
if [ ! -d "/var/www/proexpert_land" ]; then
    echo "Ошибка: Директория проекта не найдена"
    exit 1
fi

# Переход в директорию проекта
cd /var/www/proexpert_land

# Вывод информации о текущей ветке
echo "Текущая ветка Git:"
git branch

# Получение последних изменений
echo "Получение последних изменений из репозитория..."
git pull

# Установка зависимостей
echo "Установка зависимостей..."
npm install

# Сборка проекта
echo "Сборка проекта..."
npm run build

# Проверка успешности сборки
if [ ! -d "dist" ]; then
    echo "Ошибка: Сборка не удалась, директория dist не создана"
    exit 1
fi

# Проверка прав доступа на файлы
echo "Настройка прав доступа..."
sudo chown -R www-data:www-data dist

# Проверка и перезапуск Nginx если нужно
echo "Проверка конфигурации Nginx..."
sudo nginx -t

if [ $? -eq 0 ]; then
    echo "Перезапуск Nginx..."
    sudo systemctl reload nginx
else
    echo "Ошибка в конфигурации Nginx, требуется ручное исправление"
    exit 1
fi

echo "Деплой успешно завершен!"
echo "Сайт должен быть доступен в браузере"
echo "Время завершения: $(date)" 