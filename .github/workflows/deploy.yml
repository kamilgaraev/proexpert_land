name: Deploy to Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Test SSH Connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT || '22' }}
        timeout: 60s
        debug: true
        script: |
          echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..."
          whoami
          pwd
          echo "–î–æ–º–∞—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $HOME"
          ls -la ~/.ssh/ || echo "SSH –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:"
          ls -la /var/www/ || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT || '22' }}
        timeout: 60s
        command_timeout: 15m
        script: |
          set -e
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          if [ ! -d "/var/www/proexpert_land" ]; then
            echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/proexpert_land –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            sudo mkdir -p /var/www/proexpert_land
            sudo chown $USER:$USER /var/www/proexpert_land
          fi
          
          cd /var/www/proexpert_land
          echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Git –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if [ ! -d ".git" ]; then
            echo "üì¶ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
            git init
            git remote add origin https://github.com/–≤–∞—à_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–≤–∞—à_—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.git
          fi
          
          # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
          git fetch origin
          git pull origin main
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          npm ci --production=false
          
          # –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
          echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
          npm run build
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏
          if [ ! -d "dist" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è dist –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
            exit 1
          fi
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤
          echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
          sudo chown -R www-data:www-data dist
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx
          echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx..."
          sudo nginx -t
          sudo systemctl reload nginx
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω: $(date)"
          echo "üåç –°–∞–π—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!" 