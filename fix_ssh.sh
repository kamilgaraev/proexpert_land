#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –¥–ª—è –¥–µ–ø–ª–æ—è"
echo "============================="

# –°–æ–∑–¥–∞–Ω–∏–µ SSH –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ SSH –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
mkdir -p ~/.ssh
chmod 700 ~/.ssh
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ~/.ssh —Å–æ–∑–¥–∞–Ω–∞ —Å –ø—Ä–∞–≤–∞–º–∏ 700"

# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ authorized_keys
echo ""
echo "üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π–ª–∞ authorized_keys..."
touch ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
echo "‚úÖ –§–∞–π–ª authorized_keys —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–∞–≤–∞–º–∏ 600"

echo ""
echo "üìã –¢–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ authorized_keys:"
if [ -s ~/.ssh/authorized_keys ]; then
    echo "–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç $(wc -l < ~/.ssh/authorized_keys) —Å—Ç—Ä–æ–∫(–∏)"
    echo "–ü–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤ –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞:"
    cut -c1-50 ~/.ssh/authorized_keys
else
    echo "–§–∞–π–ª –ø—É—Å—Ç–æ–π - –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á"
fi

echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤—å—Ç–µ –≤–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤ authorized_keys"
echo ""
echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –∫–æ–º–∞–Ω–¥:"
echo "1. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤ —Ñ–∞–π–ª–µ:"
echo "   cat –≤–∞—à_–ø—É–±–ª–∏—á–Ω—ã–π_–∫–ª—é—á.pub >> ~/.ssh/authorized_keys"
echo ""
echo "2. –ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤—Ä—É—á–Ω—É—é:"
echo "   nano ~/.ssh/authorized_keys"
echo "   # –í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞: ssh-rsa AAAAB3NzaC... deploy@proexpert_land"
echo ""
echo "3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É echo:"
echo "   echo '–≤–∞—à_–ø—É–±–ª–∏—á–Ω—ã–π_–∫–ª—é—á' >> ~/.ssh/authorized_keys"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
echo ""
echo "üìÇ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
if [ ! -d "/var/www/proexpert_land" ]; then
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /var/www/proexpert_land..."
    sudo mkdir -p /var/www/proexpert_land
    sudo chown $USER:$USER /var/www/proexpert_land
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∞–≤–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é $USER"
else
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/proexpert_land —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    echo "–í–ª–∞–¥–µ–ª–µ—Ü: $(stat -c '%U:%G' /var/www/proexpert_land)"
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ sudo –ø—Ä–∞–≤
echo ""
echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ sudo –ø—Ä–∞–≤..."
echo "–î–æ–±–∞–≤—å—Ç–µ –≤ sudoers —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É:"
echo ""
echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload nginx, /usr/bin/nginx -t, /bin/chown -R www-data:www-data *"
echo ""
echo "–î–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "sudo visudo"
echo ""
echo "–ò –¥–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É –≤—ã—à–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞"

echo ""
echo "‚ú® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üß™ –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç check_ssh.sh" 