# Система приглашений подрядчиков

## 📋 Обзор системы

Система приглашений подрядчиков - это комплексное решение для автоматизации процесса поиска и привлечения подрядчиков в рамках строительной экосистемы. Система позволяет организациям находить проверенных партнеров, отправлять им приглашения к сотрудничеству и автоматически создавать взаимные подрядные связи.

### 🎯 Ключевые возможности

**Для заказчиков:**
- 🔍 Умный поиск подрядчиков с фильтрацией и сортировкой
- 📩 Отправка персонализированных приглашений
- 📊 Отслеживание статуса приглашений
- 🤖 Автоматические рекомендации по региону и активности
- 💳 Контроль лимитов в соответствии с тарифным планом

**Для подрядчиков:**
- 📨 Получение красивых email-приглашений
- 🏢 Детальная информация о потенциальных заказчиках
- ⚡ Быстрое принятие/отклонение приглашений
- 🔄 Автоматическая синхронизация данных
- 🤝 Создание взаимных деловых связей

### 🏗️ Архитектура системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Админка       │    │   Личный        │    │   Email         │
│   (Заказчики)   │    │   кабинет       │    │   система       │
│                 │    │   (Подрядчики)  │    │                 │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • Поиск орг-й   │    │ • Входящие      │    │ • Уведомления   │
│ • Отправка      │    │   приглашения   │    │   о приглашениях│
│   приглашений   │    │ • Принятие/     │    │ • Красивые      │
│ • Управление    │    │   отклонение    │    │   шаблоны       │
│   статусами     │    │ • Просмотр      │    │ • Автоотправка  │
│ • Статистика    │    │   заказчиков    │    │   через очереди │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Бэкенд API    │
                    │                 │
                    ├─────────────────┤
                    │ • Поиск орг-й   │
                    │ • Бизнес-логика │
                    │ • Валидация     │
                    │ • Уведомления   │
                    │ • Лимиты        │
                    │ • Синхронизация │
                    └─────────────────┘
                             │
                    ┌─────────────────┐
                    │   База данных   │
                    │                 │
                    ├─────────────────┤
                    │ • Organizations │
                    │ • Contractor    │
                    │   Invitations   │
                    │ • Contractors   │
                    │ • Users         │
                    │ • Notifications │
                    └─────────────────┘
```

## 📚 Документация

### [📖 API Документация](./api/contractor-invitations.md)
Подробное описание всех API эндпоинтов, параметров запросов и форматов ответов:
- Поиск и фильтрация организаций
- Отправка и управление приглашениями
- Принятие/отклонение приглашений
- Коды ошибок и валидация
- Лимиты и ограничения

### [🎨 UI Документация](./ui/contractor-invitations.md)
Подробные макеты пользовательских интерфейсов:
- Страницы поиска и приглашения подрядчиков
- Интерфейсы управления приглашениями
- Мобильная адаптация
- Email шаблоны и уведомления
- UX сценарии и метрики

## 🚀 Быстрый старт

### Для разработчиков фронтенда

1. **Админка (поиск подрядчиков):**
   ```javascript
   // Поиск организаций
   GET /api/v1/admin/organizations/search?search=строитель&city=Москва
   
   // Отправка приглашения
   POST /api/v1/admin/contractor-invitations
   {
     "invited_organization_id": 123,
     "message": "Приглашаем к сотрудничеству..."
   }
   ```

2. **Личный кабинет (обработка приглашений):**
   ```javascript
   // Список приглашений
   GET /api/v1/landing/contractor-invitations
   
   // Принятие приглашения
   POST /api/v1/landing/contractor-invitations/{token}/accept
   ```

### Для разработчиков бэкенда

1. **Установка миграций:**
   ```bash
   php artisan migrate
   ```

2. **Настройка очередей (для email):**
   ```bash
   php artisan queue:work
   ```

3. **Настройка cron (для истечения приглашений):**
   ```bash
   php artisan invitations:expire-contractor
   ```

## 🔧 Техническая реализация

### Основные компоненты

**Модели:**
- `ContractorInvitation` - приглашения с токенами и статусами
- `Contractor` - расширенная модель с поддержкой приглашенных организаций
- `Organization` - организации с метаданными для поиска

**Сервисы:**
- `ContractorInvitationService` - бизнес-логика приглашений
- `OrganizationDiscoveryService` - поиск и рекомендации
- `SubscriptionLimitsService` - управление лимитами

**Контроллеры:**
- `Admin/ContractorInvitationController` - API для админки
- `Admin/OrganizationSearchController` - поиск организаций
- `Landing/ContractorInvitationController` - API личного кабинета

### База данных

**Новые таблицы:**
```sql
contractor_invitations (
  id, organization_id, invited_organization_id,
  token, status, expires_at, invitation_message,
  metadata, invited_by_user_id, accepted_by_user_id
)
```

**Расширения существующих таблиц:**
```sql
contractors + (
  source_organization_id, contractor_type,
  contractor_invitation_id, connected_at,
  sync_settings, last_sync_at
)
```

### Производительность и масштабируемость

**Оптимизации БД:**
- Композитные индексы для быстрого поиска
- Уникальные ограничения на уровне БД
- Soft deletes для сохранения истории

**Кэширование:**
- Поиск организаций: 10 минут
- Статистика приглашений: 15 минут
- Проверка доступности: 5 минут

**Очереди:**
- Email уведомления через Laravel Queues
- Фоновая синхронизация данных
- Bulk операции для массовых действий

## 💼 Бизнес-логика

### Жизненный цикл приглашения

```
1. [СОЗДАНИЕ] Заказчик находит подрядчика и отправляет приглашение
   ↓
2. [ОТПРАВКА] Система отправляет email владельцам организации-подрядчика
   ↓
3. [РАССМОТРЕНИЕ] Подрядчик изучает приглашение в личном кабинете
   ↓
4. [РЕШЕНИЕ] Принятие или отклонение приглашения
   ↓
5a. [ПРИНЯТО] Создание взаимных подрядных связей + синхронизация
5b. [ОТКЛОНЕНО] Сохранение причины отказа для аналитики
```

### Лимиты по тарифам

| Тариф | Приглашений в месяц | Дополнительные возможности |
|-------|-------------------|----------------------------|
| Бесплатный | 5 | Базовый поиск |
| Базовый | 25 | Расширенные фильтры |
| Премиум | 100 | Рекомендации, аналитика |
| Корпоративный | ∞ | Приоритетная поддержка |

### Автоматизация

**Синхронизация данных:**
- Автоматическое обновление контактной информации каждые 24 часа
- Настраиваемые поля для синхронизации
- Логирование всех изменений

**Истечение приглашений:**
- Автоматическая отметка истекших приглашений (cron)
- Предупреждения за 2 дня до истечения
- Возможность продления срока действия

## 📊 Аналитика и мониторинг

### Ключевые метрики

**Конверсия:**
- CTR поиска → приглашение: ~15-25%
- Принятие приглашений: ~60-70%
- Повторные сделки: ~40%

**Производительность:**
- Время поиска: <500ms
- Отправка email: <5 секунд
- Создание связей: <1 секунда

**Использование:**
- Среднее количество приглашений на организацию: 8-12/месяц
- Пиковая нагрузка: рабочие дни 10:00-16:00
- Сезонность: +40% весной/летом

### Мониторинг

**Логирование:**
- Все критичные операции (создание, принятие, отклонение)
- Ошибки валидации и бизнес-логики
- Превышение лимитов подписки
- Проблемы с отправкой уведомлений

**Алерты:**
- Время ответа API >1 секунды
- Количество ошибок >5% от запросов
- Очередь email >1000 сообщений
- Превышение лимитов >90% пользователей

## 🔒 Безопасность

### Авторизация
- JWT токены для всех защищенных эндпоинтов
- Проверка принадлежности к организации
- Роли и права доступа (владелец, администратор)

### Валидация
- Серверная валидация всех входящих данных
- Защита от дублирования приглашений
- Проверка статуса организаций

### Приватность
- Токены приглашений: криптостойкие, одноразовые
- Логирование без персональных данных
- GDPR compliance для email уведомлений

## 🧪 Тестирование

### Unit тесты
- Все сервисы и их методы
- Валидация бизнес-правил
- Проверка лимитов и ограничений

### Integration тесты
- API эндпоинты с различными параметрами
- Email отправка через очереди
- Синхронизация данных между организациями

### E2E тесты
- Полный цикл: поиск → приглашение → принятие
- Различные сценарии (отклонение, истечение)
- Тестирование UI в разных браузерах

## 🚦 Развертывание

### Требования к серверу
- PHP 8.1+, Laravel 10+
- MySQL 8.0+ или PostgreSQL 13+
- Redis (для кэширования и очередей)
- Email SMTP сервер

### Шаги развертывания

1. **Обновление кода:**
   ```bash
   git pull origin main
   composer install --optimize-autoloader
   ```

2. **Миграции БД:**
   ```bash
   php artisan migrate --force
   ```

3. **Очистка кэша:**
   ```bash
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   ```

4. **Перезапуск очередей:**
   ```bash
   php artisan queue:restart
   ```

### Проверка работоспособности

```bash
# Проверка API
curl -H "Authorization: Bearer {token}" \
     https://api.example.com/v1/admin/organizations/search

# Проверка очередей
php artisan queue:monitor

# Проверка логов
tail -f storage/logs/laravel.log
```

## 📈 Планы развития

### Ближайшие релизы (Q1-Q2 2024)

**Функциональность:**
- Массовые приглашения (bulk invitations)
- Шаблоны сообщений для разных типов проектов
- Интеграция с CRM системами
- Мобильное приложение

**Аналитика:**
- Детальная статистика по конверсии
- A/B тестирование интерфейсов
- Предиктивная аналитика для рекомендаций
- Dashboard для руководителей

### Долгосрочная перспектива (2024-2025)

**Автоматизация:**
- AI-рекомендации подрядчиков
- Автоматическое создание договоров
- Интеграция с системами планирования
- Блокчейн верификация подрядчиков

**Экосистема:**
- Маркетплейс подрядных услуг  
- Система рейтингов и отзывов
- Страхование сделок
- Международное расширение

---

## 👥 Команда и поддержка

**Разработка:** Старший разработчик
**Тестирование:** QA команда
**Поддержка:** DevOps и техническая поддержка

**Контакты для вопросов:**
- Техническая поддержка: support@company.com
- Разработка: dev@company.com
- Документация: docs@company.com

---

*Система приглашений подрядчиков - это мощный инструмент для роста строительной экосистемы, позволяющий компаниям находить надежных партнеров и развивать взаимовыгодное сотрудничество.*